---
title: "Chile_analysis"
author: "Mathis Mallet"
date: "2024-05-15"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
source("functions_analysis_chile.R")
library(ggplot2)
library(viridis)
library(gridExtra)
library(beepr)
library(dplyr)#to manipulate datasets
library(cowplot) #for better combined graphs
library(FactoMineR)
library(tidyr)
library(purrr)
library(tibble)
library(RColorBrewer)
library(patchwork)
library(plotly)
library(reshape2) #to melt() df
#Factoshiny can be fun ^^

library(tidyverse)
library(NbClust)
library(clValid)
library(mclust) # this needs to be loaded due to error on clValid
library(kohonen)
```

#Trajctories
## Load the dataset
```{r}
dataset <- read.csv(file = "C:\\Users\\mathi\\OneDrive\\Documents\\Cours\\ENS2\\SRC_internship\\Code\\continuous_data_Chile.csv", check.names = FALSE)
```

##Constants
```{r}
common_years = c("1990","1992","1994","1996","1998","2000","2003","2006","2009","2011","2013","2015","2017","2020")
```

## Reduce data
```{r}
names <- colnames(dataset)
kept_columns <- filter_strings_with_substrings(names, c("Gini", "P9010","Energy", "IP&PU", "Agriculture", "Waste", "Mean", "Region", "Region_number"))
dataset <- dataset[, kept_columns]
```


##Represent the trajectories
```{r}
test <- data_to_plot(dataset = dataset, type1 = "GHG", subtype1 = "IP&PU", type2 = "I", subtype2 = "Gini", years = common_years)
graph_from_datasets(test)
```
#for ploting
```{r}
graph_from_datasets <- function(datasets, colbar = FALSE ){
  nb <- length(datasets)
  names <- colnames(datasets[[1]])
  if (colbar) {
    legend_obj <- theme(legend.title = element_text(size = 12),  # Adjust legend title size
          legend.text = element_text(size = 11),   # Adjust legend label size
          axis.title.x = element_text(size = 12),# Set size of x-axis labels
          axis.title.y = element_text(size = 12), # Set size of y-axis labels
          axis.text.x = element_text(size = 11),# Set size of x-axis labels
          axis.text.y = element_text(size = 11))# Set size of y-axis labels
  } else {
    legend_obj <- theme(legend.position = "none" ,
          axis.title.x = element_text(size = 10),# Set size of x-axis labels
          axis.title.y = element_text(size = 10), # Set size of y-axis labels
          axis.text.x = element_text(size = 11),# Set size of x-axis labels
          axis.text.y = element_text(size = 11))# Set size of y-axis labels
  }

  graph <- ggplot() +
    labs(
      x = names[1],
      y = names[2],
      # x = element_blank(),
      # y = element_blank(),
      color = names[3]) +
    # theme_minimal() +
    legend_obj +
    scale_color_viridis_c()
  #scale_color_gradient(low = "blue", high = "red")
  for (i in 1:nb) {
    graph <- graph +
      geom_point(data = datasets[[i]], aes(x = .data[[names[1]]], y = .data[[names[2]]], color = .data[[names[3]]])) +
      geom_path(data = datasets[[i]], aes(x = .data[[names[1]]], y = .data[[names[2]]], color = .data[[names[3]]]))
  }
  return(graph)
}

test <- data_to_plot(dataset = dataset, type1 = "GHG", subtype1 = "Energy", type2 = "I", subtype2 = "Gini", years = common_years)
energy_chile <- graph_from_datasets(test, colbar = TRUE)
ggsave("energy_chile_traj.png", plot = energy_chile, width=5, height=3) 
```

```{r}
density_from_datasets <- function(datasets, log = FALSE){
  nb <- length(datasets)
  names <- colnames(datasets[[1]])
  merged_data <- bind_rows(datasets)
  graph <- ggplot(data = merged_data, aes(x = .data[[names[1]]], y = .data[[names[2]]])) +
    stat_density_2d(geom = "raster", aes(fill = after_stat(ndensity)), contour = FALSE, contour_var = "ndensity")+
    geom_density2d() +
    # geom_density_2d_filled(contour_var = "ndensity")+
    labs(
      x = names[1],
      y = names[2],
      color = names[3]) +
    theme_minimal() +
    theme(legend.title = element_text(size = 12),  # Adjust legend title size
          legend.text = element_text(size = 11),   # Adjust legend label size
          axis.title.x = element_text(size = 10),# Set size of x-axis labels
          axis.title.y = element_text(size = 10), # Set size of y-axis labels
          axis.text.x = element_text(size = 11),# Set size of x-axis labels
          axis.text.y = element_text(size = 11)) +# Set size of y-axis labels
    scale_fill_distiller(palette= "Spectral", direction=-1)+
    scale_color_viridis_c()+
    if (log) {
      scale_x_continuous(trans='log10')
    }
    # labs(
    #   x = element_blank(),
    #   y = element_blank())
  return(graph)
}
# temp <- data_to_plot(dataset = dataset_REG, type1 = "GHG", subtype1 = "Total", type2 = "I", subtype2 = "Gini", years = common_years)
energy_chile <- density_from_datasets(test)
ggsave("energy_chile_dens.png", plot = energy_chile, width=5, height=3) 
energy_chile
```



```{r}
#scatter_data(dataset, "W", "I", sup = "")
#scatter_data(dataset, "W", "GHG", sup = "")
#scatter_data(dataset, "GHG", "I", sup = "") # no Aysen is with the filter [!(dataset$Region_number == 11),]

#scatter_data(dataset[!(dataset$Region_number == 11),], "W", "I", sup = "-no_Aysen")
#scatter_data(dataset[!(dataset$Region_number == 11),], "W", "GHG", sup = "-no_Aysen")
#scatter_data(dataset[!(dataset$Region_number == 11),], "GHG", "I", sup = "-no_Aysen")

# scatter_data(dataset, "GHG", "I", sup = "-reduced")
beep(2)
```

```{r}
test <- data_to_plot(dataset = dataset, type1 = "GHG", subtype1 = "IP&PU", type2 = "I", subtype2 = "Gini", years = common_years)

density_from_datasets(datasets = test)
```
```{r}

```


```{r}
#scatter_density_data(dataset, "W", "I", sup = "")
#scatter_density_data(dataset, "W", "GHG", sup = "")
#scatter_density_data(dataset, "GHG", "I", sup = "")

#scatter_density_data(dataset[!(dataset$Region_number == 11),], "W", "I", sup = "-no_Aysen")
#scatter_density_data(dataset[!(dataset$Region_number == 11),], "W", "GHG", sup = "-no_Aysen")
#scatter_density_data(dataset[!(dataset$Region_number == 11),], "GHG", "I", sup = "-no_Aysen")

# scatter_density_data(dataset, "GHG", "I", sup = "-reduced")
# scatter_density_data(dataset, "W", "I", sup = "-reduced")
# scatter_density_data(dataset, "W", "GHG", sup = "-reduced")
# beep(2)
```
#PCA

```{r}
res.pca <- PCA(dataset[,3:length(dataset)], graph = FALSE, ncp = 6)
```

```{r}
summary(res.pca)
```

```{r}
test <- plot_PCs_ind(PCA = res.pca)
test
```
```{r}
coord <- modif_PCs_var(PCA = res.pca)
coord
```

```{r}
test <- plot_PCs_var(res.pca)
test
```

```{r}
res <- combined_PCA_plot(PCA = res.pca, dim1 = 1, dim2 = 2)
ggsave("chile_1_2.png", plot = res, width = 11, height = 7)
res
```


##Load the dataset
```{r}
dataset <- read.csv(file = "C:\\Users\\mathi\\OneDrive\\Documents\\Cours\\ENS2\\SRC_internship\\Code\\continuous_data_Chile_with_GI.csv", check.names = FALSE)
```


##Constants
```{r}
common_years = c("1992","1994","1996","1998","2000","2003","2006","2009","2011","2013","2015","2017","2020")

columns_to_keep <- colnames(dataset)[1:2]
columns_to_keep <- c(columns_to_keep, filter_strings_with_substrings(strings = colnames(dataset), substrings = common_years))
dataset <- dataset[, (names(dataset) %in% columns_to_keep)]
```

## MFA formating
```{r}
columns_and_group <- sorted_columns(dataset, year = FALSE)
columns <- columns_and_group$sorted_columns
group <- columns_and_group$group_name
columns <- c(colnames(dataset)[1:2],columns)
dataset <- dataset[, columns]
```

```{r}
# scatter_data(dataset, "GHG", "GI", sup = "")
# scatter_density_data(dataset[!(dataset$Region_number == 11),], "GHG", "GI", sup = "-no_Aysen")
```


```{r}
res.pca <- PCA(dataset[,3:length(dataset)], graph = FALSE, ncp = 12, scale.unit=TRUE)
summary(res.pca)
```

```{r}
res <- combined_PCA_plot(PCA = res.pca, dim1 = 1, dim2 = 2)
# ggsave("test.png", plot = res, width = 11, height = 7)
# res
```
#Clustering
```{r}

```

```{r}
n <- 8

# using first 10 components
x <- res.pca$ind$coord
clust_num <- NbClust(
    data = (as.data.frame(x[,1:n]) %>% select(where(is.numeric))),
    #distance = "maximum",
    min.nc = 2, max.nc = 5, 
    method = "ward.D2",  # minimize the total within-cluster variance
    index = 'all')
```

```{r}
# print(clust_num$All.index)
print(clust_num$Best.nc)
print(clust_num$Best.partition)
```

```{r}
## Stability & Internal validation
stab <- clValid(
    obj = x[,1:n] ,
    nClust = 5,
    clMethods = c(
        "hierarchical", "kmeans",  "som", 
        "model", "diana", "sota", "pam", "clara", "agnes"),
    validation = c('stability', "internal"),
    # metric = "manhattan",
    method = "ward",
    verbose = FALSE
) ## Hierarchical is the optimal method
```
```{r}
summary(stab)
```
```{r}
clust <- agnes(x[,1:n], method = "ward")
clust
```

```{r}
pltree(clust, cex = 0.6, hang = -1, main = "Dendrogram") 
```
```{r}
#cut the dendrogram into 4 clusters
groups <- cutree(clust, k=5)
groups
```

```{r}

res <- combined_PCA_plot(PCA = res.pca, dim1 = 1, dim2 = 2, color = TRUE, group = groups)
ggsave("group_chile.png", plot = res, width = 11, height = 7)
res

```
```{r}
dimdesc(res.pca)
```

#MFA



```{r}
n <- length(colnames(dataset)) - 2
nb_in_group <- n/length(group)
group_id = c(rep(nb_in_group,length(group)))
res.mfa = MFA(dataset[3:length(dataset)], group = group_id, type = c(rep("s",length(group))), ncp = 8, name.group = group, axes = 1:2)
```

```{r}
names(res.mfa)
```
```{r}
res <- combined_PCA_plot(PCA = res.mfa$global.pca , dim1 = 1, dim2 = 2, color = TRUE, group = groups)
res
```
```{r}
res.pca <- PCA(dataset[,3:length(dataset)], graph = FALSE, ncp = 6, scale.unit=TRUE)
res <- combined_PCA_plot(PCA = res.pca , dim1 = 1, dim2 = 2, color = TRUE, group = groups)
res
```



```{r}
plot_variance(res.mfa)
```
#New methodology
##Doing an MFA and a PCA

###Load the dataset
```{r}
dataset <- read.csv(file = "C:\\Users\\mathi\\OneDrive\\Documents\\Cours\\ENS2\\SRC_internship\\Code\\continuous_data_Chile_with_GI.csv", check.names = FALSE)
```


###Constants
```{r}
common_years = c("1992","1994","1996","1998","2000","2003","2006","2009","2011","2013","2015","2017","2020")

columns_to_keep <- colnames(dataset)[1:2]
columns_to_keep <- c(columns_to_keep, filter_strings_with_substrings(strings = colnames(dataset), substrings = common_years))
dataset <- dataset[, (names(dataset) %in% columns_to_keep)]
```

###MFA formating
```{r}
columns_and_group <- sorted_columns(dataset, year = FALSE)
columns <- columns_and_group$sorted_columns
group <- columns_and_group$group_name
columns <- c(colnames(dataset)[1:2],columns)
dataset <- dataset[, columns]
```
###MFA calculation
```{r}
n <- length(colnames(dataset)) - 2
nb_in_group <- n/length(group)
group_id = c(rep(nb_in_group,length(group)))
res.mfa = MFA(dataset[3:length(dataset)], group = group_id, type = c(rep("s",length(group))), ncp = 20, name.group = group, axes = 1:2)
```
###Screening eigenvalues
```{r}
plot_variance(res.mfa)
print(res.mfa$eig)
```
###Applying Kaiser criterion (here we keep the first 6th component)
```{r}
res.mfa = MFA(dataset[3:length(dataset)], group = group_id, type = c(rep("s",length(group))), ncp = 9, name.group = group, axes = 1:2, graph = FALSE)
res.pca <- res.mfa$global.pca
```

##Clustering
```{r}
x <- res.pca$ind$coord
clust_num <- NbClust(
    data = (as.data.frame(x) %>% select(where(is.numeric))),
    #distance = "maximum",
    min.nc = 2, max.nc = 4,
    method = "ward.D2",  # minimize the total within-cluster variance
    index = 'all') #best is 2
# beep(sound = 2)
```


###Clustering sub-optimal ward method ?
```{r}
res.hcpc <- HCPC(res.pca, kk = Inf, min = 1, max = 5, consol = TRUE, nb.clust = 4)
```


### within inertia and gain
```{r}
# res.hcpc$call$t
epci_clust <- data.frame(
  code = dataset$Region_number,
  clust = res.hcpc$data.clust$clust
)

print(table(res.hcpc$data.clust$clust))
```

#### Not exactly the same results with an MFA and a PCA
```{r}
plot_clusters_var <- function(res.hcpc, common_years, i){
  data <- res.hcpc$desc.var$quanti[[i]]
  data <- var_to_var_over_time(data, common_years)
  
  data <- rownames_to_column(data, var = "variables")
  
  melted_data <- melt(data, id.vars = "variables", variable.name = "year", value.name = "Z")
  # print(data)
  # print( melted_data)
  plot <- ggplot(melted_data, aes(x = year, y = variables, fill= Z)) +
    geom_tile(color = "white",
              lwd = 1.5,
              linetype = 1)+
    # scale_fill_continuous(
    #   na.value = "seashell2",
    #   type = "viridis",
    #   limits = c(-3,3),
    #   oob = scales::squish)+
    scale_fill_gradient2(low = "#999933", 
                         mid = "#DDCC77", 
                         high = "#CC6677", 
                         midpoint = 0,
                         na.value = "seashell2",
                         limits = c(-3,3),
                         oob = scales::squish)+
    geom_text(aes(label = round(Z, digits = 1)), color = "white", size = 4.5, fontface = "bold") +
    # ggtitle(paste0("Cluster n° ",as.character(i))) +
    theme_minimal()+
    theme(
          legend.position = "none",
          axis.title.x = element_text(size = 12),# Set size of x-axis labels
          axis.title.y = element_text(size = 12), # Set size of y-axis labels
          axis.text = element_text(size = 12))# Set size of axis labels)
  return(plot)
}
plot_clusters_var(res.hcpc,common_years, 1)
```

```{r}
plot_clusters_var(res.hcpc,common_years, 1)
plot_clusters_var(res.hcpc,common_years, 2)
plot_clusters_var(res.hcpc,common_years, 3)
plot_clusters_var(res.hcpc,common_years, 4)
# plot_clusters_var(res.hcpc,common_years, 5)
```
```{r}
p1 <- plot_clusters_var(res.hcpc,common_years, 1)
p2 <- plot_clusters_var(res.hcpc,common_years, 2)
p3 <- plot_clusters_var(res.hcpc,common_years, 3)
p4 <- plot_clusters_var(res.hcpc,common_years, 4)
# p5 <- plot_clusters_var(res.hcpc,common_years, 5)
# p6 <- plot_clusters_var(res.hcpc,common_years, 6)
```
```{r}
# Create a list of plots including the text grobs
plots <- list(
  stylish_text("Cluster C.1"),
  p1, 
   stylish_text("Cluster C.2"),
  p2,
  stylish_text("Cluster C.3"),
  p3, 
  stylish_text("Cluster C.4"),
  p4
)
# Arrange the plots in a grid
grid_plots <- arrangeGrob(grobs = plots, ncol = 1, nrow = 8, widths = c(3), heights = c(0.2,3,0.2,3,0.2,3,0.2,3))

ggsave("clusters_N_Chile.png", plot = grid_plots, width=8, height=12) 
```

#Map

```{r}

library(ggplot2)
library(sf)
library(rnaturalearth)
library(rnaturalearthdata)
library(dplyr)

```

```{r}
# Load the data for US states
map <- ne_states(country = "chile", returnclass = "sf")

clust_in_order <- c(4,4,2,1,1,4,1,1,1,1,1,1,1,1,3,2)
map$color_var <- clust_in_order
```

```{r}
plot_map <- function(map, linewidth = 0.1, lty = 1, manual_value = FALSE, colors = c("#DF536B","#61D04F","#2297E6","#F5C710","gray62","#CD0BBC","#28E2E5" ), labels){
  plot <- ggplot(data = map) +
  geom_sf(aes(fill = color_var), color = "white", size = 1, linewidth = linewidth, lty = lty) +
  theme_minimal() +
  # labs(title = "Colored States of the USA",
  #      subtitle = "Random colors assigned to states",
  #      caption = "Source: Natural Earth") +
  theme(legend.position = "right")
        # legend.key.height= unit(0.3, 'cm'),
        # legend.key.width= unit(0.3, 'cm'),
        # legend.title = element_text(size=10),
        # legend.text = element_text(size=8))
  # coord_sf(xlim = c(-80,-60))
  if (manual_value) {
      col_label <- scale_fill_manual(values = colors,
                    name = "Cluster", labels= labels)
      plot <- plot + col_label
  }
  return(plot)
}

plot_map(map, manual_value = TRUE, labels = c("R.1", "R.2","A","B"), linewidth = 0.1,
         colors = c("#F5C710","#CD0BBC","green","red"))
```

```{r}
plot <- ggplot(data = map) +
  geom_sf(aes(fill = as.factor(color_var)), color = "white", size = 1, linewidth = 0.1) +
  scale_fill_manual(values = c("#F5C710","#2297E6","#61D04F" ,"#CD0BBC"),
                    name = "Cluster", labels = c("C.1","C.2","C.3","C.4")) +
  theme_minimal() +
  # labs(title = "Colored States of the USA",
  #      subtitle = "Random colors assigned to states",
  #      caption = "Source: Natural Earth") +
  theme(legend.position = "right")+
  coord_sf(xlim = c(-80,-60))

ggsave("map_Chile.png", plot = plot, width=4, height=6) 
```


