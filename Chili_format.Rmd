---
title: "test"
author: "Mathis Mallet"
date: "2024-04-29"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:


Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
```{r}
library(haven) #better function for reading read_dta
library(foreign) #to read dta files read.dta
source("C:\\Users\\mathi\\OneDrive\\Documents\\Cours\\ENS2\\SRC_internship\\Code\\functions.R") #import our local functions
source("C:\\Users\\mathi\\OneDrive\\Documents\\Cours\\ENS2\\SRC_internship\\Code\\functions_format_chili.R")
library(progress)
library(ineq)
library(openxlsx) #to read xlsx files of pop
library(dplyr)
library(readxl)
```

# Opening GHG data
```{r}
filenames <- list.files("C:\\Users\\mathi\\OneDrive\\Documents\\Cours\\ENS2\\SRC_internship\\Data\\Chile\\Updated\\GHG_all_regions_1990_2020", pattern="*.csv", full.names=TRUE)
ldf <- lapply(filenames, read.csv)
res <- lapply(ldf, summary)
names(ldf) <- substr(filenames, 106, 150)
names(res) <- substr(filenames, 106, 150)
```

```{r}
region_index <- list(
  Antofagasta.csv = 2,
  Araucania.csv = 9,
  AricayParinacota.csv = 15,
  Atacama.csv = 3,
  Aysen.csv = 11,
  Biobio.csv = 8,
  Coquimbo.csv = 4,
  LosLagos.csv = 10,
  LosRios.csv = 14,
  Magallanes.csv = 12,
  Maule.csv = 7,
  Metropolitana.csv = 13,
  Nuble.csv = 16,
  Ohiggins.csv = 6,
  Tarapaca.csv = 1,
  Valparaiso.csv = 5
)

```


```{r}
regions <- names(ldf)
cpt <- 0
for (region in regions){
  cpt <- cpt + 1
  new_line <- region_GHG_line(name = region, region_index = region_index, ldf = ldf)
  if (cpt > 1) {
    GHG_data <- merge(GHG_data, new_line, all = TRUE)
  } else {
    GHG_data <- new_line
  }
}

```

```{r}
sum_of_8and16 <- GHG_data[GHG_data$Region_number == 8, 3:length(colnames(GHG_data))] + GHG_data[GHG_data$Region_number == 16, 3:length(colnames(GHG_data))]
sum_of_1and15 <- GHG_data[GHG_data$Region_number == 1, 3:length(colnames(GHG_data))] + GHG_data[GHG_data$Region_number == 15, 3:length(colnames(GHG_data))]
sum_of_10and14 <- GHG_data[GHG_data$Region_number == 10, 3:length(colnames(GHG_data))] + GHG_data[GHG_data$Region_number == 14, 3:length(colnames(GHG_data))]

GHG_data[GHG_data$Region_number == 8, -c(1:2)] <- sum_of_8and16
GHG_data[GHG_data$Region_number == 1, -c(1:2)] <- sum_of_1and15
GHG_data[GHG_data$Region_number == 10, -c(1:2)] <- sum_of_10and14
GHG_data <- GHG_data[!(GHG_data$Region_number %in% c(16,15,14)) ,]

GHG_data <- GHG_data[order(GHG_data$Region_number),]
```


```{r}
multiple_plot(GHG_data)
```

#Reading Pop data
```{r}
pop1992 <- read.xlsx("C:\\Users\\mathi\\OneDrive\\Documents\\Cours\\ENS2\\SRC_internship\\Data\\Chile\\Updated\\Population_Chile\\1992.xlsx", sheet = "Sheet1")

pop2002 <- read.xlsx("C:\\Users\\mathi\\OneDrive\\Documents\\Cours\\ENS2\\SRC_internship\\Data\\Chile\\Updated\\Population_Chile\\2002.xlsx", sheet = "Sheet1")

pop2017 <- read.xlsx("C:\\Users\\mathi\\OneDrive\\Documents\\Cours\\ENS2\\SRC_internship\\Data\\Chile\\Updated\\Population_Chile\\2017.xlsx", sheet = "Sheet1")
```
# Formating in the old 13 regions
```{r}
pop2002 <- pop_to_old_regions(pop2002)
pop2017 <- pop_to_old_regions(pop2017)
```
#Interpolating to get all the years between 1990 and 2020
```{r}
region_index <- pop1992$r
region_pop <- data.frame(
  Region_number = region_index
)

Years = c(1990:2020)
for (year in Years) {
  year_pop = c()
  for (i in region_index) {
    if (year < 2002) {
      a = (pop2002[pop2002$r == i,]$pop - pop1992[pop1992$r == i,]$pop)/(2002-1992)
      pop = a*(year-1992) + pop1992[pop1992$r == i,]$pop
    } else if (year == 2002) {
      pop = pop2002[pop2002$r == i,]$pop
    } else {
      a = (pop2002[pop2002$r == i,]$pop - pop2017[pop2017$r == i,]$pop)/(2002-2017)
      pop = a*(year-2002) + pop2002[pop2002$r == i,]$pop
    }
    year_pop <- c(year_pop, pop)
  }
  region_pop[as.character(year)] <- year_pop
}
```

```{r}
cpt = 0
for (i in region_index){
  if (cpt == 0){
    plot(Years, region_pop[region_pop$Region_number == i,2:32], type = "o", main = "Regional population", xlab = "years", ylab = "pop", col = rainbow(length(region_index))[i], xlim = c(1990, 2023), ylim = c(min(region_pop[,2:32]), max(region_pop[,2:32])))
    cpt = 1
  } else {
    points(Years, region_pop[region_pop$Region_number == i,2:32], type = "o", col = rainbow(length(region_index))[i])
  }
}
legend("topright", legend = region_index, col = rainbow(length(region_index)), pch = 1)
```
```{r}
cpt = 0
for (i in region_index[-13]){
  if (cpt == 0){
    plot(Years, region_pop[region_pop$Region_number == i,2:32], type = "o", main = "Regional population", xlab = "years", ylab = "pop", col = rainbow(length(region_index))[i], xlim = c(1990, 2023), ylim = c(min(region_pop[!(region_pop$Region_number == 13),2:32]), max(region_pop[!(region_pop$Region_number == 13),2:32])))
    cpt = 1
  } else {
    points(Years, region_pop[region_pop$Region_number == i,2:32], type = "o", col = rainbow(length(region_index))[i])
  }
}
legend("topright", legend = region_index, col = rainbow(length(region_index)), pch = 1)
```
# kTCO2 eq to TCO2 eq / hab (to execute only once !)
```{r}
for (i in region_index){
  for (y in Years){
    pop = region_pop[region_pop$Region_number == i, as.character(y)]
    year_columns <- get_year_columns(data = GHG_data[,3:length(GHG_data)], year = y)
    GHG_data[region_pop$Region_number == i, year_columns] <- GHG_data[region_pop$Region_number == i, year_columns]*1000/pop
  }
}
```

```{r}
multiple_plot(data = GHG_data, unit = "T CO2 eq / hab")
```
```{r}
multiple_plot(data = GHG_data[!(GHG_data$Region_number == 11),], unit = "T CO2 eq / hab")
```

```{r}
multiple_plot(data = GHG_data[(GHG_data$Region_number %in% c(10:13)),], unit = "T CO2 eq / hab")
```

# Opening wealth micro-data
```{r}

filenames <- list.files("C:\\Users\\mathi\\OneDrive\\Documents\\Cours\\ENS2\\SRC_internship\\Data\\Chile\\Updated\\Weath_and_inequalitites", pattern="*.dta", full.names=TRUE)
ldf <- lapply(filenames,read_dta)
res <- lapply(ldf, summary)
names(ldf) <- substr(filenames, 109, 112)
names(res) <- substr(filenames, 109, 112)
```
```{r}
print(names(ldf))
```

```{r}
data <- ldf[["1990"]]
subdata <- subset(data, select = c("r","f","o","numper","yauthaj","ysubhaj","yaimhaj"))
subdata$ytothaj <- subdata$yauthaj + subdata$ysubhaj + subdata$yaimhaj 
subdata$ypchaj <-subdata$ytothaj/subdata$numper
```

```{r}
IN_1990 <- region_IN_data(data = subdata,year = 1990)
```

```{r}
data <- ldf[["1992"]]
subdata <- subset(data, select = c("r","f","o","numper","yauthaj","ysubhaj","yaimhaj"))
subdata$ytothaj <- subdata$yauthaj + subdata$ysubhaj + subdata$yaimhaj 
subdata$ypchaj <-subdata$ytothaj/subdata$numper
```

```{r}
IN_1992 <- region_IN_data(data = subdata,year = 1992)
```

```{r}
data <- ldf[["1994"]]
subdata <- subset(data, select = c("r","f","o","numper","yauthaj","ysubhaj","yaimhaj"))
subdata$ytothaj <- subdata$yauthaj + subdata$ysubhaj + subdata$yaimhaj 
subdata$ypchaj <-subdata$ytothaj/subdata$numper
```

```{r}
IN_1994 <- region_IN_data(data = subdata,year = 1994)
```

```{r}
data <- ldf[["1996"]]
subdata <- subset(data, select = c("r","f","o","numper","yauthaj","ysubhaj","yaimhaj"))
subdata$ytothaj <- subdata$yauthaj + subdata$ysubhaj + subdata$yaimhaj 
subdata$ypchaj <-subdata$ytothaj/subdata$numper
```

```{r}
IN_1996 <- region_IN_data(data = subdata,year = 1996)
```

```{r}
data <- ldf[["1998"]]
subdata <- subset(data, select = c("r","f","o","numper","yauthaj","ysubhaj","yaimhaj"))
subdata$ytothaj <- subdata$yauthaj + subdata$ysubhaj + subdata$yaimhaj 
subdata$ypchaj <-subdata$ytothaj/subdata$numper
```

```{r}
IN_1998 <- region_IN_data(data = subdata,year = 1998)
```

```{r}
data <- ldf[["2000"]]
subdata <- subset(data, select = c("r","o","numper","yauthaj","ysubhaj","yaimhaj"))
subdata$ytothaj <- subdata$yauthaj + subdata$ysubhaj + subdata$yaimhaj 
subdata$ypchaj <-subdata$ytothaj/subdata$numper
```

```{r}
IN_2000 <- region_IN_data(data = subdata,year = 2000)
```

```{r}
data <- ldf[["2003"]]
subdata <- subset(data, select = c("r","o","numper","yauthaj","ysubhaj","yaimhaj"))
subdata$ytothaj <- subdata$yauthaj + subdata$ysubhaj + subdata$yaimhaj 
subdata$ypchaj <-subdata$ytothaj/subdata$numper
```

```{r}
IN_2003 <- region_IN_data(data = subdata,year = 2003)
```

```{r}
data <- ldf[["2006"]]
subdata <- subset(data, select = c("r","o","numper","yauthaj","ysubhaj","yaimhaj"))
subdata$ytothaj <- subdata$yauthaj + subdata$ysubhaj + subdata$yaimhaj 
subdata$ypchaj <-subdata$ytothaj/subdata$numper
```

```{r}
IN_2006 <- region_IN_data(data = subdata,year = 2006)
```

```{r}
data <- ldf[["2009"]]
subdata <- subset(data, select = c("region","o","numper","yauthaj","ysubhaj","yaimhaj"))
subdata$ytothaj <- subdata$yauthaj + subdata$ysubhaj + subdata$yaimhaj 
subdata$ypchaj <-subdata$ytothaj/subdata$numper
colnames(subdata)[colnames(subdata) == "region"] <- "r"
clean_subdata <- subdata[!is.na(subdata$r), ]
```

```{r}
IN_2009 <- region_IN_data(data = clean_subdata,year = 2009)
```

```{r}
data <- ldf[["2011"]]
subdata <- subset(data, select = c("region","o","numper","yauthaj","ysubhaj","yaimhaj"))
subdata$ytothaj <- subdata$yauthaj + subdata$ysubhaj + subdata$yaimhaj 
subdata$ypchaj <-subdata$ytothaj/subdata$numper
colnames(subdata)[colnames(subdata) == "region"] <- "r"
```

```{r}
IN_2011 <- region_IN_data(data = subdata,year = 2011)
```

```{r}
data <- ldf[["2013"]]
subdata <- subset(data, select = c("region","o","numper","ypchtot"))
colnames(subdata)[colnames(subdata) == "region"] <- "r"
colnames(subdata)[colnames(subdata) == "ypchtot"] <- "ypchaj"
```

```{r}
IN_2013 <- region_IN_data(data = subdata,year = 2013)
```

```{r}
data <- ldf[["2015"]]
subdata <- subset(data, select = c("region","o","numper","ypchtot"))
colnames(subdata)[colnames(subdata) == "region"] <- "r"
colnames(subdata)[colnames(subdata) == "ypchtot"] <- "ypchaj"
```

```{r}
IN_2015 <- region_IN_data(data = subdata,year = 2015)
```

```{r}
data <- ldf[["2017"]]
subdata <- subset(data, select = c("region","o","numper","ypc")) #ypc Ingreso Total per cápita del hogar corregido 
#ypch Ingreso Total per cápita del hogar
colnames(subdata)[colnames(subdata) == "region"] <- "r"
colnames(subdata)[colnames(subdata) == "ypc"] <- "ypchaj"
```

```{r}
IN_2017 <- region_IN_data(data = subdata,year = 2017)
```

```{r}
data <- ldf[["2020"]]
subdata <- subset(data, select = c("region","o","numper","ypchtotcor")) 
colnames(subdata)[colnames(subdata) == "region"] <- "r"
colnames(subdata)[colnames(subdata) == "ypchtotcor"] <- "ypchaj"
```

```{r}
IN_2020 <- region_IN_data(data = subdata,year = 2020)
```

```{r}
data <- ldf[["2022"]]
subdata <- subset(data, select = c("region","numper","ypc")) 
colnames(subdata)[colnames(subdata) == "region"] <- "r"
colnames(subdata)[colnames(subdata) == "ypc"] <- "ypchaj"
```

```{r}
IN_2022 <- region_IN_data(data = subdata,year = 2022)
```

```{r}
all_dataframes <- list(GHG_data, IN_2022, IN_2020, IN_2017, IN_2015, IN_2013, IN_2011, IN_2009, IN_2006, IN_2003, IN_2000, IN_1998, IN_1996, IN_1994, IN_1992, IN_1990)

cpt = 1
for (df in all_dataframes){
  if (!("Region_number" %in% colnames(df))) {
    print(names(df)[cpt], "missing")
  }
  if (any(duplicated(unlist(colnames(df))))){
    print(names(df)[cpt], "duplicated")
  }
  cpt = cpt + 1
}


dataset <- Reduce(function(x,y) merge(x,y, by = "Region_number", all = TRUE), all_dataframes)
```

```{r}
write.csv(dataset, "continuous_data_Chile.csv", row.names = FALSE)
```

```{r}
file_path <- "C:\\Users\\mathi\\OneDrive\\Documents\\Cours\\ENS2\\SRC_internship\\Data\\Chile\\Updated\\Inequalities_and_wealth\\Tablas_Mujeres.xlsx"

# Read sheet "15" from line 3 and until column Q
schooling <- read_excel(file_path, sheet = "15", range = cell_limits(c(3, 1), c(NA, 17)))

# Read sheet "17" from line 3 and until column Q
labor_force <- read_excel(file_path, sheet = "17", range = cell_limits(c(3, 1), c(NA, 17)))

# Read sheet "18" from line 3 and until column Q
unemployement <- read_excel(file_path, sheet = "18", range = cell_limits(c(3, 1), c(NA, 17)))
```
### common formating
```{r}
schooling <- schooling[schooling$Level == "region-sexo",]
labor_force <- labor_force[labor_force$Level == "region-sexo",]
unemployement <- unemployement[unemployement$Level == "region-sexo",]
```

```{r}
regions <- unique(schooling$subtype1)
print(regions)
```
```{r}
Region_numbers <- list("Región de Tarapacá" = 1, 
                       "Región de Antofagasta" = 2, 
                       "Región de Atacama" = 3, 
                       "Región de Coquimbo" = 4,
                       "Región de Valparaíso" = 5,
                       "Región del Libertador Gral. Bernardo O'Higgins" = 6,
                       "Región del Maule" = 7,
                       "Región del Biobío" = 8,
                       "Región de La Araucanía" = 9,
                       "Región de Los Lagos" = 10,
                       "Región de Aysén del Gral. Carlos Ibáñez del Campo" = 11,
                       "Región de Magallanes y de la Antártica Chilena" = 12,
                       "Región Metropolitana de Santiago" = 13,
                       "Región de Los Ríos" = 14,
                       "Región de Arica y Parinacota" = 15,
                       "Región de Ñuble" = 16)
```

```{r}
add_region_number <- function(dataset, Region_numbers){
  column <- c()
  for (region in dataset$subtype1){
    column <- c(column, Region_numbers[[region]])
  }
  dataset["Region_number"] <- column
  return(dataset)
}

schooling <- add_region_number(schooling, Region_numbers)
labor_force <- add_region_number(labor_force, Region_numbers)
unemployement <- add_region_number(unemployement, Region_numbers)
```

```{r}
pop2002 <- read.xlsx("C:\\Users\\mathi\\OneDrive\\Documents\\Cours\\ENS2\\SRC_internship\\Data\\Chile\\Updated\\Population_Chile\\2002.xlsx", sheet = "Sheet1")

pop2017 <- read.xlsx("C:\\Users\\mathi\\OneDrive\\Documents\\Cours\\ENS2\\SRC_internship\\Data\\Chile\\Updated\\Population_Chile\\2017.xlsx", sheet = "Sheet1")
```
#Interpolating to get all the years between 2002 and 2020
```{r}
region_index <- pop2002$r
region_pop <- data.frame(
  Region_number = region_index
)

Years = c(2002:2020)
for (year in Years) {
  year_pop = c()
  for (i in region_index) {
    if (year == 2002) {
      pop = pop2002[pop2002$r == i,]$pop
    } else {
      a = (pop2002[pop2002$r == i,]$pop - pop2017[pop2017$r == i,]$pop)/(2002-2017)
      pop = a*(year-2002) + pop2002[pop2002$r == i,]$pop
    }
    year_pop <- c(year_pop, pop)
  }
  region_pop[as.character(year)] <- year_pop
}
```



# Formating in the right shape while calculating the indicator
```{r}
schooling_int <- data.frame(
  Region_number = c(1:13)
)
columns <-  colnames(schooling)
for (year in columns[5:(length(columns)-1)]){
  year_data <- schooling[,c("Region_number","subtype2",year)]
  education_ratio <- c()
  for (reg_num in c(1:13)){
    region <- year_data[year_data$Region_number == reg_num,]
    male <- region[region$subtype2 == "Hombre", year][[1]]
    female <-  region[region$subtype2 == "Mujer", year][[1]]
    
    if (reg_num == 8){
      region_bis <- year_data[year_data$Region_number == 16,]
      male_bis <- region_bis[region_bis$subtype2 == "Hombre", year][[1]]
      female_bis <-  region_bis[region_bis$subtype2 == "Mujer", year][[1]]
      if (is.na(female_bis)){
        ratio <- female/male
      } else {
        pop <- region_pop[region_pop$Region_number == reg_num,year][[1]]
        pop_bis <- region_pop[region_pop$Region_number == 16,year][[1]]
        weight <- pop / (pop + pop_bis)
        weight_bis <- pop_bis / (pop + pop_bis)
        ratio <- (weight*female + weight_bis*female_bis) / (weight*male + weight_bis*male_bis)
      }
    } else if (reg_num == 1){
      region_bis <- year_data[year_data$Region_number == 15,]
      male_bis <- region_bis[region_bis$subtype2 == "Hombre", year][[1]]
      female_bis <-  region_bis[region_bis$subtype2 == "Mujer", year][[1]]
      if (is.na(female_bis)){
        ratio <- female/male
      } else {
        pop <- region_pop[region_pop$Region_number == reg_num,year][[1]]
        pop_bis <- region_pop[region_pop$Region_number == 15,year][[1]]
        weight <- pop / (pop + pop_bis)
        weight_bis <- pop_bis / (pop + pop_bis)
        ratio <- (weight*female + weight_bis*female_bis) / (weight*male + weight_bis*male_bis)
      }
    }
      else if (reg_num == 10){
        region_bis <- year_data[year_data$Region_number == 14,]
        male_bis <- region_bis[region_bis$subtype2 == "Hombre", year][[1]]
        female_bis <-  region_bis[region_bis$subtype2 == "Mujer", year][[1]]
        if (is.na(female_bis)){
          ratio <- female/male
        } else {
          pop <- region_pop[region_pop$Region_number == reg_num,year][[1]]
          pop_bis <- region_pop[region_pop$Region_number == 14,year][[1]]
          weight <- pop / (pop + pop_bis)
          weight_bis <- pop_bis / (pop + pop_bis)
          ratio <- (weight*female + weight_bis*female_bis) / (weight*male + weight_bis*male_bis)
        } 
      } else {
        ratio <- female/male
    }
    education_ratio <- c(education_ratio, ratio)
  }
  colname <- paste0("GI-education-",year)
  schooling_int[colname] <- education_ratio
}
```

```{r}
labor_force_int <- data.frame(
  Region_number = c(1:13)
)

labor_force <- labor_force[labor_force$Category == "Participa del mercado laboral",]
columns <-  colnames(labor_force)
for (year in columns[5:(length(columns)-1)]){
  year_data <- labor_force[,c("Region_number","subtype2",year)]
  labor_ratio <- c()
  for (reg_num in c(1:13)){
    region <- year_data[year_data$Region_number == reg_num,]
    male <- region[region$subtype2 == "Hombre", year][[1]]
    female <-  region[region$subtype2 == "Mujer", year][[1]]
    
    if (reg_num == 8){
      region_bis <- year_data[year_data$Region_number == 16,]
      male_bis <- region_bis[region_bis$subtype2 == "Hombre", year][[1]]
      female_bis <-  region_bis[region_bis$subtype2 == "Mujer", year][[1]]
      if (is.na(female_bis)){
        ratio <- female/male
      } else {
        pop <- region_pop[region_pop$Region_number == reg_num,year][[1]]
        pop_bis <- region_pop[region_pop$Region_number == 16,year][[1]]
        weight <- pop / (pop + pop_bis)
        weight_bis <- pop_bis / (pop + pop_bis)
        ratio <- (weight*female + weight_bis*female_bis) / (weight*male + weight_bis*male_bis)
      }
    } else if (reg_num == 1){
      region_bis <- year_data[year_data$Region_number == 15,]
      male_bis <- region_bis[region_bis$subtype2 == "Hombre", year][[1]]
      female_bis <-  region_bis[region_bis$subtype2 == "Mujer", year][[1]]
      if (is.na(female_bis)){
        ratio <- female/male
      } else {
        pop <- region_pop[region_pop$Region_number == reg_num,year][[1]]
        pop_bis <- region_pop[region_pop$Region_number == 15,year][[1]]
        weight <- pop / (pop + pop_bis)
        weight_bis <- pop_bis / (pop + pop_bis)
        ratio <- (weight*female + weight_bis*female_bis) / (weight*male + weight_bis*male_bis)
      }
    }
      else if (reg_num == 10){
        region_bis <- year_data[year_data$Region_number == 14,]
        male_bis <- region_bis[region_bis$subtype2 == "Hombre", year][[1]]
        female_bis <-  region_bis[region_bis$subtype2 == "Mujer", year][[1]]
        if (is.na(female_bis)){
          ratio <- female/male
        } else {
          pop <- region_pop[region_pop$Region_number == reg_num,year][[1]]
          pop_bis <- region_pop[region_pop$Region_number == 14,year][[1]]
          weight <- pop / (pop + pop_bis)
          weight_bis <- pop_bis / (pop + pop_bis)
          ratio <- (weight*female + weight_bis*female_bis) / (weight*male + weight_bis*male_bis)
        } 
      } else {
        ratio <- female/male
    }
    labor_ratio <- c(labor_ratio, ratio)
  }
  colname <- paste0("GI-labor-",year)
  labor_force_int[colname] <- labor_ratio
}
```


```{r}
unemployement_int <- data.frame(
  Region_number = c(1:13)
)

unemployement <- unemployement[unemployement$Category == "Desocupado",]
columns <-  colnames(unemployement)
for (year in columns[5:(length(columns)-1)]){
  year_data <- unemployement[,c("Region_number","subtype2",year)]
  unemployement_ratio <- c()
  for (reg_num in c(1:13)){
    region <- year_data[year_data$Region_number == reg_num,]
    male <- region[region$subtype2 == "Hombre", year][[1]]
    female <-  region[region$subtype2 == "Mujer", year][[1]]
    
    if (reg_num == 8){
      region_bis <- year_data[year_data$Region_number == 16,]
      male_bis <- region_bis[region_bis$subtype2 == "Hombre", year][[1]]
      female_bis <-  region_bis[region_bis$subtype2 == "Mujer", year][[1]]
      if (is.na(female_bis)){
        ratio <- female/male
      } else {
        pop <- region_pop[region_pop$Region_number == reg_num,year][[1]]
        pop_bis <- region_pop[region_pop$Region_number == 16,year][[1]]
        weight <- pop / (pop + pop_bis)
        weight_bis <- pop_bis / (pop + pop_bis)
        ratio <- (weight*female + weight_bis*female_bis) / (weight*male + weight_bis*male_bis)
      }
    } else if (reg_num == 1){
      region_bis <- year_data[year_data$Region_number == 15,]
      male_bis <- region_bis[region_bis$subtype2 == "Hombre", year][[1]]
      female_bis <-  region_bis[region_bis$subtype2 == "Mujer", year][[1]]
      if (is.na(female_bis)){
        ratio <- female/male
      } else {
        pop <- region_pop[region_pop$Region_number == reg_num,year][[1]]
        pop_bis <- region_pop[region_pop$Region_number == 15,year][[1]]
        weight <- pop / (pop + pop_bis)
        weight_bis <- pop_bis / (pop + pop_bis)
        ratio <- (weight*female + weight_bis*female_bis) / (weight*male + weight_bis*male_bis)
      }
    }
      else if (reg_num == 10){
        region_bis <- year_data[year_data$Region_number == 14,]
        male_bis <- region_bis[region_bis$subtype2 == "Hombre", year][[1]]
        female_bis <-  region_bis[region_bis$subtype2 == "Mujer", year][[1]]
        if (is.na(female_bis)){
          ratio <- female/male
        } else {
          pop <- region_pop[region_pop$Region_number == reg_num,year][[1]]
          pop_bis <- region_pop[region_pop$Region_number == 14,year][[1]]
          weight <- pop / (pop + pop_bis)
          weight_bis <- pop_bis / (pop + pop_bis)
          ratio <- (weight*female + weight_bis*female_bis) / (weight*male + weight_bis*male_bis)
        } 
      } else {
        ratio <- female/male
    }
    unemployement_ratio <- c(unemployement_ratio, ratio)
  }
  colname <- paste0("GI-unemployement-",year)
  unemployement_int[colname] <- unemployement_ratio
}
```

```{r}
dataset <- read.csv(file = "C:\\Users\\mathi\\OneDrive\\Documents\\Cours\\ENS2\\SRC_internship\\Code\\continuous_data_Chile.csv", check.names = FALSE)
```

```{r}
all_dataframes <- list(dataset, schooling_int, unemployement_int, labor_force_int)

new_dataset <- Reduce(function(x,y) merge(x,y, by = "Region_number", all = TRUE), all_dataframes)
```

```{r}
write.csv(new_dataset, "continuous_data_Chile_with_GI.csv", row.names = FALSE)
```

